# **Capítulo 11 – Border Gateway Protocol (BGP)**

## **1. Introducción**

El **Border Gateway Protocol (BGP)**, definido en **RFC 4271**, es un protocolo de enrutamiento **inter-dominio (EGP)** utilizado para intercambiar información de enrutamiento entre **sistemas autónomos (AS)**.  
Es el **protocolo base de Internet** y también se usa en grandes redes empresariales y entornos de proveedores.

- **Tipo:** Path-Vector (vector de ruta)
    
- **Protocolo de transporte:** TCP (puerto 179)
    
- **Versión actual:** BGP-4 (con soporte multiprotocolo RFC 2858)
    
- **Ámbitos de uso:** Internet global, redes MPLS L3VPN, redes ISP y centros de datos a gran escala.
    

---

## **2. Conceptos fundamentales**

### **Autonomous System (AS)**

Un **AS** es un conjunto de routers bajo una misma administración y política de enrutamiento.  
Cada AS se identifica con un número único (**ASN**, de 16 o 32 bits).

**Rangos privados:**

- 16-bit: 64 512 – 65 535
    
- 32-bit: 4 200 000 000 – 4 294 967 294
    

---

## **3. Tipos de BGP**

|Tipo|Descripción|
|---|---|
|**eBGP** (External BGP)|Entre routers de **diferentes AS**. Usado para interconexión con otras organizaciones o Internet.|
|**iBGP** (Internal BGP)|Entre routers del **mismo AS**. Distribuye rutas aprendidas por eBGP dentro del dominio.|

**Nota:**

- eBGP usa **TTL = 1** (vecinos directamente conectados).
    
- iBGP usa **TTL = 255**.
    
- BGP **no descubre vecinos automáticamente**, deben configurarse manualmente.
    

---

## **4. Tablas BGP**

BGP mantiene tres bases de datos internas:

|Tabla|Función|
|---|---|
|**Neighbor Table**|Guarda los vecinos configurados y el estado de sus sesiones TCP.|
|**BGP Table**|Contiene todas las rutas recibidas y sus atributos (RIB-in).|
|**IP Routing Table**|Solo almacena la mejor ruta seleccionada por el algoritmo BGP.|

---

## **5. Tipos de mensajes BGP**

|Mensaje|Descripción|
|---|---|
|**OPEN**|Negocia los parámetros iniciales de la sesión (AS, ID, versión, hold time).|
|**UPDATE**|Anuncia, actualiza o retira rutas (NLRI + atributos).|
|**NOTIFICATION**|Indica errores y termina la sesión BGP.|
|**KEEPALIVE**|Mantiene viva la sesión (1/3 del hold time, por defecto 60 s).|

---

## **6. Estados del vecino BGP**

1. **Idle** – Espera evento de inicio o intento TCP.
    
2. **Connect** – Detecta intento de conexión TCP.
    
3. **Active** – Intenta establecer TCP con retry timer.
    
4. **OpenSent** – Envía mensaje OPEN y espera respuesta.
    
5. **OpenConfirm** – Espera KEEPALIVE para confirmar.
    
6. **Established** – Sesión operativa; intercambio de UPDATE y KEEPALIVE.
    

---

## **7. Algoritmo Path Vector y atributos BGP**

BGP intercambia información de **Network Layer Reachability Information (NLRI)** junto con una serie de **atributos de ruta**, que son los que permiten aplicar políticas de enrutamiento.

### **Atributos Well-Known Mandatory**

- **AS_PATH** – Lista de AS recorridos; previene loops (menor = mejor).
    
- **NEXT_HOP** – Dirección IP del siguiente salto.
    
- **ORIGIN** – Origen de la ruta (IGP < EGP < Incomplete).
    

### **Atributos Well-Known Discretionary**

- **LOCAL_PREF** – Preferencia de salida dentro del AS (mayor = mejor).
    
- **ATOMIC_AGGREGATE** – Indica que hubo agregación de rutas.
    

### **Atributos Optional**

- **MED (Multi-Exit Discriminator)** – Preferencia de entrada (menor = mejor).
    
- **COMMUNITY** – Etiquetas que agrupan rutas con mismo tratamiento.
    
- **AGGREGATOR** – Identifica el router que realizó la agregación.
    
- **WEIGHT** (propietario Cisco) – Valor local (no se propaga). Mayor = mejor.
    

---

## **8. Proceso de selección de la mejor ruta**

El orden estándar de decisión en Cisco BGP es:

1. **Highest Weight**
    
2. **Highest Local Preference**
    
3. **Originated Locally** (`network` o `aggregate`)
    
4. **Shortest AS_PATH**
    
5. **Lowest Origin Type** (IGP < EGP < Incomplete)
    
6. **Lowest MED** (si mismo AS de origen)
    
7. **Prefer eBGP over iBGP**
    
8. **Lowest IGP metric to NEXT_HOP**
    
9. **Lowest Router ID**
    

---

## **9. Configuración básica de eBGP**

**Escenario:** AS 65000 (Service Provider) y AS 65001 (Cliente).

**Router SP1**

```
router bgp 65000
 neighbor 192.168.1.1 remote-as 65001
 network 10.0.30.0 mask 255.255.255.0
```

**Router R1**

```
router bgp 65001
 neighbor 192.168.1.10 remote-as 65000
 network 10.0.10.0 mask 255.255.255.0
```

**Comandos de verificación:**

```
show ip bgp summary
show ip bgp neighbors
show ip bgp
show ip route bgp
```

---

## **10. Verificación y salida de ejemplo**

```
R1# show ip bgp summary
Neighbor     V  AS MsgRcvd MsgSent TblVer InQ OutQ Up/Down State/PfxRcd
192.168.1.10 4 65000      7      9     4    0    0 00:02:33       1
```

```
R1# show ip bgp
*> 10.0.10.0/24 192.168.1.1 0 65001 i
*> 10.0.20.0/24 192.168.2.1 0 65002 i
*> 10.0.30.0/24 0.0.0.0 32768 i
```

```
R1# show ip route bgp
B   10.0.10.0/24 [20/0] via 192.168.1.1
B   10.0.20.0/24 [20/0] via 192.168.2.1
```
---

## **11. Comandos esenciales para examen ENCOR**

|Propósito|Comando|
|---|---|
|Iniciar BGP|`router bgp <AS>`|
|Configurar vecino|`neighbor <IP> remote-as <AS>`|
|Anunciar red|`network <red> mask <máscara>`|
|Verificar vecinos|`show ip bgp neighbors`|
|Resumen de sesiones|`show ip bgp summary`|
|Rutas en tabla|`show ip bgp`|
|Rutas en RIB|`show ip route bgp`|

---

## **12. Resumen de estados y diagnóstico**

- **Idle ↔ Active:** falla en AS o TCP.
    
- **Established:** sesión correcta.
    
- **BGP Hold Time = 180 s (Keepalive = 60 s).**
    

**Comando útil:**

```
debug ip bgp
debug ip bgp

```


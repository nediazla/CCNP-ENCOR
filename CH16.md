# **Capítulo 16 – Overlay Tunnels**

## **1. Introducción**

Un **overlay tunnel** permite que dos o más routers o dispositivos se comuniquen de forma segura o aislada a través de una red intermedia que **no tiene conocimiento de los detalles internos del tráfico**.

El principio es sencillo pero poderoso:

> “Encapsular un paquete IP dentro de otro paquete IP.”

**Aplicaciones comunes:**

- Interconexión de redes privadas a través de Internet (VPN).
    
- Transporte de IPv6 sobre IPv4 (o viceversa).
    
- Extensión de redes corporativas en SD-WAN o Data Centers.
    
- Simulación de enlaces dedicados entre sedes remotas.
    

---

## **2. Conceptos Clave**

|Concepto|Descripción|
|---|---|
|**Underlay**|Red física existente (por ejemplo, Internet o MPLS).|
|**Overlay**|Red virtual creada sobre el underlay mediante túneles.|
|**Encapsulación**|Proceso de insertar un paquete dentro de otro (IP-in-IP, GRE, VXLAN).|
|**Desencapsulación**|El router destino elimina el encabezado extra y reenvía el paquete original.|

**Ventaja:** El overlay crea **conectividad lógica** sin necesidad de cambiar el enrutamiento del underlay.

---

## **3. Tipos de Túneles Comunes**

|Tipo|Capa|Características principales|
|---|---|---|
|**GRE (Generic Routing Encapsulation)**|Capa 3|Encapsula casi cualquier protocolo; sin cifrado.|
|**IPsec Tunnel**|Capa 3|Proporciona confidencialidad, autenticación e integridad.|
|**DMVPN (Dynamic Multipoint VPN)**|Capa 3|Construye túneles dinámicos con NHRP.|
|**MPLS L3VPN**|Capa 3|Transporte seguro usando etiquetas MPLS.|
|**VXLAN (Virtual Extensible LAN)**|Capa 2 sobre L3|Usado en Data Centers y SD-Access.|

---

## **4. GRE (Generic Routing Encapsulation)**

**GRE** es un protocolo de Cisco estandarizado en RFC 2784.  
Encapsula cualquier paquete de capa 3 dentro de otro paquete IP.

**Características:**

- Protocolo IP número 47.
    
- Soporta IPv4/IPv6, multicast y routing dinámico.
    
- Sin cifrado ni autenticación.
    
- Usa una **interfaz lógica Tunnel**.
    

**Configuración básica:**

```
interface Tunnel0
 ip address 10.10.10.1 255.255.255.252
 tunnel source GigabitEthernet0/0
 tunnel destination 198.51.100.2
```

**Verificación:**

```
show interface tunnel0
show ip interface brief
show ip route
```
**Encabezado GRE:**

- 4 bytes de encabezado GRE.
    
- 20 bytes de encabezado IP adicional.
    

**Limitación:**  
No protege los datos → suele combinarse con IPsec.

---

## **5. GRE + IPsec**

Para obtener **seguridad**, GRE puede cifrarse mediante IPsec.

Ventajas:

- GRE permite protocolos de enrutamiento (OSPF, EIGRP).
    
- IPsec cifra el tráfico.
    

**Estructura del paquete:**

```
[IP original] → GRE header → [Nuevo IP header] → IPsec
```

**Configuración general:**

1. Configurar el túnel GRE.
    
2. Crear ACL que identifique el tráfico del túnel.
    
3. Configurar transform-set y crypto map IPsec.
    
4. Aplicar el crypto map en la interfaz WAN.
    

---

## **6. IPsec Site-to-Site Tunnels**

IPsec proporciona **confidencialidad, integridad y autenticación** mediante criptografía.

### **Protocolos principales**

|Componente|Función|
|---|---|
|**IKEv2**|Negociación automática de seguridad.|
|**ESP (Encapsulating Security Payload)**|Cifra y autentica datos.|
|**AH (Authentication Header)**|Autenticación sin cifrado.|

**Modos:**

- **Transport Mode:** solo cifra el payload (host-a-host).
    
- **Tunnel Mode:** cifra todo el paquete IP (gateway-a-gateway).
    

**Configuración resumida:**

```
crypto isakmp policy 10
 encr aes
 authentication pre-share
 group 5
crypto isakmp key cisco123 address 198.51.100.2
!
crypto ipsec transform-set TSET esp-aes esp-sha-hmac
crypto map VPN 10 ipsec-isakmp
 set peer 198.51.100.2
 set transform-set TSET
 match address 100
!
access-list 100 permit ip 10.0.0.0 0.0.0.255 10.1.0.0 0.0.0.255
interface GigabitEthernet0/0
 crypto map VPN
```
**Verificación:**

```
show crypto isakmp sa
show crypto ipsec sa
```

---

## **7. DMVPN (Dynamic Multipoint VPN)**

Desarrollado por Cisco para **escalar VPNs dinámicamente**.  
Combina GRE multipunto, NHRP e IPsec.

**Componentes:**

- **Hub:** punto central (NHRP server).
    
- **Spokes:** sedes remotas que se conectan dinámicamente.
    
- **NHRP (Next Hop Resolution Protocol):** resuelve las direcciones públicas de los spokes.
    

**Ventajas:**

- Los spokes pueden comunicarse entre sí sin pasar por el hub.
    
- Se crean túneles **“on-demand”**.
    
- Escala a cientos de sedes.
    

**Configuración simplificada:**

```
interface Tunnel0
 ip address 172.16.1.1 255.255.255.0
 tunnel source GigabitEthernet0/0
 tunnel mode gre multipoint
 tunnel key 100
 ip nhrp network-id 100
 ip nhrp map multicast dynamic
```
**Verificación:**

```
show dmvpn 
show ip nhrp
```

---

## **8. VXLAN (Virtual Extensible LAN)**

Protocolo de **capa 2 sobre capa 3** (RFC 7348), diseñado para entornos **Data Center y SD-Access**.

**Características:**

- Encapsula tramas Ethernet en UDP.
    
- Usa **VNI (VXLAN Network Identifier)** de 24 bits → hasta 16 millones de redes virtuales.
    
- Utiliza **VTEP (VXLAN Tunnel Endpoints)** como puntos de entrada/salida.
    
- Permite extender VLANs a través de la red IP (overlay sobre underlay IP).
    

**Encabezado VXLAN:**

- Ethernet + IP + UDP + VXLAN header (8 bytes).
    
- UDP puerto 4789.
    

**Estructura:**

```
[Ethernet Frame]
   ↓
VXLAN Header (VNI)
   ↓
UDP Header (4789)
   ↓
IP Header (Underlay)
```

**Aplicaciones:**

- Cisco ACI, SD-Access, Data Center overlays.
    
- Integración con EVPN (BGP-EVPN) para control plane.
    

---

## **9. GENEVE, LISP y otros overlays modernos**

- **LISP (Locator/ID Separation Protocol):** separa la identidad (EID) de la localización (RLOC).
    
    - Usado en Cisco SD-Access y SD-WAN.
        
    - Facilita movilidad de endpoints y escalabilidad.
        
- **GENEVE (Generic Network Virtualization Encapsulation):**
    
    - Estándar de IETF que unifica VXLAN, NVGRE y STT.
        
    - Soporta metadatos extensibles en la cabecera.
        
    - Usado en entornos multi-tenant y cloud (VMware NSX-T).
        

---

## **10. Troubleshooting de túneles**

|Problema|Verificación|
|---|---|
|No hay conectividad|`show interface tunnel`|
|No se levanta el túnel|`show ip route` para rutas del destino.|
|Error de IPsec|`show crypto isakmp sa`, `show crypto ipsec sa`|
|DMVPN fallando|`show dmvpn`, `show ip nhrp`|
|VXLAN inactivo|`show nve interface`, `show vxlan`|

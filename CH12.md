# **Capítulo 12 – Advanced BGP**

## **1. Introducción**

Este capítulo amplía los fundamentos del capítulo anterior.  
El foco es la **escalabilidad**, **control de políticas**, y **extensiones multiprotocolo** de BGP.  
Las grandes redes empresariales y de proveedores requieren mecanismos para optimizar el número de sesiones, el control de rutas internas y externas, y la interoperabilidad entre IPv4, IPv6 y VPNs.

---

## **2. Escalabilidad del iBGP**

Por defecto, iBGP requiere una **conexión full-mesh** entre todos los routers del AS (cada router iBGP debe conectarse a todos los demás).  
Esto escala muy mal:

- Para _n_ routers, se necesitan _n(n-1)/2_ sesiones TCP.
    

### **Soluciones:**

1. **Route Reflectors (RR)**
    
2. **Confederations**
    

---

## **3. Route Reflectors (RR)**

Un **Route Reflector** permite reducir las sesiones iBGP al actuar como punto central que “refleja” las rutas recibidas de sus clientes.

### **Conceptos clave**

- **RR (Route Reflector):** Router que redistribuye rutas entre sus clientes.
    
- **Client:** Router iBGP registrado como cliente del RR.
    
- **Non-client:** Router iBGP que no es cliente (recibe rutas solo si tiene sesión directa).
    
- **Cluster ID:** Identificador del clúster de reflexión.
    
- **Originator-ID:** Indica qué router generó originalmente la ruta.
    

### **Reglas de propagación**

- Rutas recibidas de **un cliente** se reenvían a **otros clientes y no-clientes**.
    
- Rutas recibidas de **un no-cliente** se reenvían **solo a clientes**.
    
- Se evita loop con los atributos **Cluster-List** y **Originator-ID**.
    

### **Configuración básica**

```
router bgp 65000
 bgp cluster-id 1
 neighbor 10.1.1.2 remote-as 65000
 neighbor 10.1.1.2 route-reflector-client
```
### **Ventajas**

- Reduce el número de sesiones iBGP.
    
- Fácil de implementar.
    
- Compatible con redundancia (varios RRs).
    

**Desventaja:**  
Puede introducir asimetría de rutas si no se diseña correctamente.

---

## **4. Confederations**

Las **BGP Confederations** dividen un gran AS en varios **sub-AS internos**, reduciendo la complejidad sin afectar las políticas externas.

### **Características**

- Cada sub-AS se comunica internamente con **iBGP o eBGP interno**.
    
- Hacia fuera, todos los sub-AS se comportan como **un único AS**.
    
- En el atributo **AS_PATH**, los sub-AS internos se muestran entre paréntesis `()`.
    

Ejemplo:

```
(65001) 65020 65030
```

### **Configuración básica**

```
router bgp 65000
 bgp confederation identifier 65000
 bgp confederation peers 65001 65002
```

**Uso:**  
Muy común en **ISP** o **grandes redes MPLS**.

---

## **5. BGP Policy Control (Políticas de enrutamiento)**

BGP no elige rutas solo por métrica, sino por **políticas configuradas por el administrador**.  
Estas políticas usan herramientas como:

|Herramienta|Función principal|
|---|---|
|**Prefix-list**|Filtra redes específicas.|
|**AS-path access-list**|Controla rutas según AS_PATH.|
|**Route-map**|Aplica acciones sobre rutas (match / set).|
|**Community / Extended Community**|Clasifica y etiqueta rutas.|

---

## **6. Manipulación de atributos BGP**

### **A) Local Preference**

- Atributo interno (iBGP).
    
- Determina la **preferencia de salida** del AS.
    
- Valor más alto = mejor.
    

```
route-map SET_LOCAL_PREF permit 10
 set local-preference 200
neighbor 192.168.1.1 route-map SET_LOCAL_PREF in
```

### **B) MED (Multi-Exit Discriminator)**

- Atributo externo (eBGP).
    
- Indica preferencia de entrada al AS.
    
- Valor más bajo = mejor.
    

```
route-map SET_MED permit 10
 set metric 50
neighbor 10.1.1.1 route-map SET_MED out
```
### **C) Weight**

- Atributo **local de Cisco**.
    
- Solo se aplica al router local.
    
- Mayor = preferido.
    

```
neighbor 10.1.1.1 weight 500
```

### **D) Community**

Permite agrupar rutas para aplicar políticas globales.

```
route-map ADD_COMMUNITY permit 10
 set community 65000:100 no-export
neighbor 10.1.1.1 route-map ADD_COMMUNITY out
```

Valores comunes:

- **no-export** → no enviar fuera del AS.
    
- **no-advertise** → no anunciar a nadie.
    
- **local-AS** → no salir del sub-AS en confederaciones.
    

---

## **7. BGP Filtering Tools**

### **Prefix-list**

```
ip prefix-list BLOCK_PRIVATE deny 10.0.0.0/8 le 32
ip prefix-list BLOCK_PRIVATE deny 192.168.0.0/16 le 32
ip prefix-list BLOCK_PRIVATE permit 0.0.0.0/0 le 32
```

### **AS-path Filter**

```
ip as-path access-list 10 permit ^65001$
neighbor 192.168.1.1 filter-list 10 in
```

---

## **8. Multiprotocol BGP (MP-BGP)**

**MP-BGP** (RFC 2858) amplía BGP-4 para soportar múltiples familias de direcciones:  
IPv4, IPv6, VPNv4, VPNv6, etc.

### **Atributos clave**

- **AFI (Address Family Identifier)** – tipo de protocolo (IPv4 = 1, IPv6 = 2)
    
- **SAFI (Subsequent AFI)** – tipo de servicio (unicast, multicast, VPN, etc.)
    

|AFI|SAFI|Tipo|
|---|---|---|
|1|1|IPv4 Unicast|
|2|1|IPv6 Unicast|
|1|128|VPNv4|
|2|128|VPNv6|

### **Ejemplo de configuración IPv6**

```
router bgp 65000
 address-family ipv6 unicast
  neighbor 2001:db8::2 activate
  neighbor 2001:db8::2 route-reflector-client
```

---

## **9. Route Aggregation**

Combina múltiples rutas específicas en una sola ruta resumen.

```
aggregate-address 10.0.0.0 255.255.0.0 summary-only
```

Opcionalmente:

```
set originator-id 1.1.1.1
set atomic-aggregate
```

---

## **10. BGP Dampening**

Evita la propagación de rutas **inestables (flapping)** penalizando rutas que cambian frecuentemente de estado.

```
bgp dampening 15 750 2000 30
```

- 15 → half-life (minutos)
    
- 750 → reuse limit
    
- 2000 → suppress limit
    
- 30 → tiempo máximo de supresión
    

---

## **11. Graceful Restart y Route Refresh**

- **Graceful Restart:** mantiene la sesión activa durante reinicios controlados.
    
```
bgp graceful-restart
```
    
- **Route Refresh:** permite volver a solicitar rutas sin reiniciar la sesión.
    
```
neighbor 10.1.1.1 route-refresh
```
    

---

## **12. BGP Multipath (Load-balancing)**

Permite instalar **múltiples rutas BGP** con mismo destino y misma métrica.

```
maximum-paths 4
bgp bestpath as-path multipath-relax
```

**Requisitos:**

- Mismo AS_PATH
    
- Misma Local Pref
    
- Misma MED
    
- Misma Next-Hop
    

---

## **13. Verificación**

```
show ip bgp summary
show ip bgp community
show ip bgp regexp
show ip bgp dampened-paths
show bgp ipv6 unicast summary
```
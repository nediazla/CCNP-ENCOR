## **Capítulo 10 – Border Gateway Protocol (BGP)**

### **1. Introducción**

**BGP (Border Gateway Protocol)**, definido en **RFC 4271**, es el protocolo de enrutamiento que permite el **intercambio de rutas entre sistemas autónomos (AS)**.  
Es el **protocolo de enrutamiento de Internet** y se utiliza también en grandes entornos empresariales y de proveedores.

**Tipo:** Path-Vector (vector de ruta)  
**Puerto TCP:** 179  
**Propósito:** mantener control administrativo sobre las rutas y evitar bucles a gran escala.  
**Versión actual:** BGP-4 con soporte **multiprotocolo (MP-BGP, RFC 2858)**.

---

## **2. Tipos de sesiones BGP**

|Tipo|Descripción|
|---|---|
|**eBGP**|Entre routers de distintos AS. Utilizado para intercambio entre organizaciones.|
|**iBGP**|Entre routers del mismo AS. Distribuye información BGP internamente.|

**Reglas básicas:**

- eBGP suele usar **TTL = 1** (vecinos directamente conectados).
    
- iBGP usa **TTL = 255** y requiere conectividad de capa 3 previa.
    
- BGP **no descubre vecinos dinámicamente** — deben configurarse manualmente.
    

**Ejemplo básico de configuración eBGP:**

```
router bgp 65000
 neighbor 192.168.1.1 remote-as 65001
 network 10.0.30.0 mask 255.255.255.0
```

---

## **3. Tablas internas de BGP**

|Tabla|Función|
|---|---|
|**Neighbor Table**|Lista de vecinos configurados y su estado de conexión TCP.|
|**BGP Table (RIB-In)**|Contiene todas las rutas recibidas de los vecinos.|
|**IP Routing Table (RIB)**|Solo incluye la mejor ruta seleccionada por el proceso de path-selection.|

**Comandos de verificación:**

```
show ip bgp summary
show ip bgp neighbors
show ip bgp
show ip route bgp
```

---

## **4. Estados de sesión BGP**

|Estado|Descripción|
|---|---|
|**Idle**|Espera la configuración del vecino o temporizador de reconexión.|
|**Connect**|Intenta establecer sesión TCP con el vecino.|
|**Active**|Reintenta conexión si falló.|
|**OpenSent**|Envía mensaje _OPEN_ al vecino.|
|**OpenConfirm**|Espera _KEEPALIVE_.|
|**Established**|Sesión estable; intercambio de rutas activo.|

**Verificación:**

```
show ip bgp summary
```

---

## **5. Tipos de mensajes BGP**

|Tipo|Función|
|---|---|
|**OPEN**|Establece sesión y parámetros iniciales.|
|**UPDATE**|Anuncia o retira rutas.|
|**KEEPALIVE**|Mantiene la sesión activa (por defecto cada 60 s).|
|**NOTIFICATION**|Informa de errores o cierre de sesión.|

---

## **6. Atributos BGP**

Los **atributos** determinan cómo se selecciona la mejor ruta y cómo se comparte con otros vecinos.

|Atributo|Tipo|Descripción|
|---|---|---|
|**Weight**|Cisco-proprietary|Valor local (mayor = mejor). No se propaga.|
|**Local Preference (LOCAL_PREF)**|Well-known discretionary|Determina salida preferida dentro del AS (mayor = mejor).|
|**AS_PATH**|Well-known mandatory|Lista de AS atravesados (menor = preferido).|
|**Origin**|Well-known mandatory|Origen de la ruta (IGP < EGP < Incomplete).|
|**MED (Multi-Exit Discriminator)**|Optional non-transitive|Indica preferencia de entrada hacia un AS (menor = mejor).|
|**Next-Hop**|Well-known mandatory|Dirección IP hacia el siguiente salto.|
|**Atomic Aggregate**|Well-known discretionary|Indica que se ha realizado una agregación de rutas.|
|**Aggregator**|Optional transitive|Identifica el router que realizó la agregación.|
|**Community**|Optional transitive|Permite etiquetar rutas con políticas comunes.|

---

## **7. Proceso de selección de la mejor ruta**

BGP usa los atributos anteriores en orden de prioridad:

1. **Weight** (mayor gana)
    
2. **Local Preference** (mayor gana)
    
3. **Ruta originada localmente** (network o aggregate)
    
4. **AS_PATH** (menor gana)
    
5. **Origin Type** (IGP < EGP < Incomplete)
    
6. **MED** (menor gana; solo si mismo AS origen)
    
7. **eBGP > iBGP**
    
8. **IGP cost al Next-Hop** (menor gana)
    
9. **Menor Router ID**
    

**Ejemplo:**

```
*> 10.0.10.0/24 192.168.1.1 0 65001 i
*> 10.0.20.0/24 192.168.2.1 0 65002 i
*> 10.0.30.0/24 0.0.0.0 32768 i
```

El “>” indica la mejor ruta seleccionada.

---

## **8. Configuración de vecinos y verificación**

**Configuración eBGP simple:**

```
router bgp 65000
 neighbor 192.168.1.1 remote-as 65001
 network 10.0.30.0 mask 255.255.255.0
```

**Comprobación del estado:**

```
show ip bgp summary
show ip bgp neighbors
```

**Salidas clave:**

- AS remoto
    
- Versiones BGP
    
- Rutas recibidas y enviadas
    
- Tiempo de sesión activa
    
- Prefijos recibidos
    

---

## **9. Advertencia y filtrado de rutas**

**Network statement:**  
Inyecta rutas de la tabla de enrutamiento local a BGP (no habilita interfaces).

**Ejemplo:**

```
network 172.16.0.0 mask 255.255.255.0
```

**Filtrado y manipulación de atributos:**

```
route-map SET_WEIGHT permit 10
 set weight 200
!
neighbor 192.168.1.1 route-map SET_WEIGHT in
```

**Políticas comunes:**

- `distribute-list` (ACL)
    
- `prefix-list`
    
- `route-map`
    
- `filter-list` (para AS_PATH)
    

---

## **10. Hard vs Soft Reset**

- **Hard reset:** `clear ip bgp *` → reinicia la sesión TCP (disruptivo).
    
- **Soft reset:** `clear ip bgp * soft in|out` → actualiza rutas sin interrumpir sesión.
    

---

## **11. iBGP Consideraciones**

- Los routers iBGP **no redistribuyen rutas aprendidas de otros iBGP**.  
    → Solución: usar **Route Reflectors (RR)** o **Confederaciones**.
    

### **a) Route Reflectors**

- Un **RR** permite que sus clientes intercambien rutas sin formar full-mesh.
    
- Los routers no clientes solo se comunican con el RR.
    
- Atributos adicionales: _Originator-ID_ y _Cluster-List_.
    

### **b) Confederaciones**

- Divide un gran AS en sub-AS internos para reducir complejidad.
    
- Los sub-AS se comunican internamente como eBGP, externamente como un solo AS.
    
- Mantiene políticas separadas y mejora la escalabilidad.
    

---

## **12. Agregación y Atomic Aggregate**

Cuando se resume un conjunto de rutas, se agrega el atributo **Atomic Aggregate** indicando que se ha perdido información específica.

**Ejemplo:**

```
aggregate-address 10.0.0.0 255.255.0.0 summary-only
```

---

## **13. Verificación de rutas**

```
show ip bgp
show ip route bgp
show ip bgp neighbors
show ip bgp summary
```

**Ejemplo:**

```
BGP routing table entry for 10.0.20.0/24
Paths: (2 available, best #2)
  65001
    192.168.2.1 from 192.168.2.1 (10.0.20.2)
      Origin IGP, localpref 100, valid, external, best
```

**Códigos:**

- `*` válido
    
- `>` mejor ruta
    
- `i` iBGP
    
- `e` eBGP
    
- `r` RIB-failure
    

---

## **14. Datos de examen clave**

|Concepto|Valor / Detalle|
|---|---|
|Protocolo de transporte|TCP 179|
|Tipo de protocolo|Path Vector|
|AD eBGP|20|
|AD iBGP|200|
|Well-known attributes|AS_PATH, NEXT_HOP, ORIGIN, LOCAL_PREF, ATOMIC_AGGREGATE|
|Optional attributes|MED, Aggregator, Community|
|ECMP|Soportado (limitado)|
|Multiprotocol BGP|Soporta IPv4, IPv6, VPNv4, L2VPN|
|Comando resumen|`aggregate-address`|
|Comando verificación|`show ip bgp summary`|
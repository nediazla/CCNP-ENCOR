**CAPÍTULO 4**

**Protocolo Spanning Tree Múltiple**

Este capítulo cubre el siguiente tema:

- **Protocolo Spanning Tree Múltiple (MST):** Esta sección examina los beneficios y el funcionamiento de MST.
    

Este capítulo completa la sección de Spanning Tree explicando el **Protocolo Spanning Tree Múltiple (MST)**. MST es **uno de los tres modos de STP** compatibles con los switches Catalyst.

---

**Protocolo Spanning Tree Múltiple**

El estándar original **802.1D** solo admitía **una instancia de STP** para toda una red de switches. En esta situación, conocida como **Spanning Tree Común (CST)**, **todas las VLANs utilizan la misma topología**, lo que significa que **no era posible compartir la carga de tráfico** entre enlaces bloqueando enlaces para VLANs específicas en un enlace y bloqueándolos para otras VLANs en enlaces alternos.

La **Figura 4-1** muestra **cuatro VLANs** compartiendo la misma topología. Todo el tráfico de red desde **SW2 hacia SW3** debe atravesar **SW1**. Si la **VLAN 4** contenida en **SW2 y SW3**, la topología **no podría optimizarse** con tráfico que vaya directamente entre los dos switches.

Cisco desarrolló el protocolo **Per-VLAN Spanning Tree (PVST)** para permitir una **topología STP por cada VLAN**. Con **PVST**, el **root bridge** puede ubicarse en un switch diferente o los **costos de puerto** pueden configurarse de forma distinta **por VLAN**. Esto permite que **un enlace esté bloqueado para una VLAN y reenviando para otra**.

![[20260102074830.png]]

La **Figura 4-2** demuestra cómo los **tres switches** mantienen una **topología STP para cada una de las 4 VLANs**. Si se agregaran **10 VLANs más** a este entorno, los switches tendrían que **mantener 14 topologías STP**. Con la **tercera instancia de STP**, para la **VLAN 3**, el **puerto en estado de bloqueo** se mueve al **enlace SW1 ↔ SW3** para ajustar la topología STP y abordar las **necesidades de tráfico** entre **SW2 (donde se conectan los servidores)** y **SW3 (donde se conectan los clientes)**. En la **cuarta instancia de STP**, los dispositivos en la **VLAN 4** residen solo en **SW2 y SW3**, por lo que **mover el puerto en bloqueo** al enlace **SW2 ↔ SW1** permite un **flujo de tráfico óptimo**.

![[20260102074925.png]]

Ahora, en entornos con **miles de VLANs**, mantener un **estado STP para todas las VLANs** puede convertirse en una **carga para los procesadores del switch**. Los switches deben **procesar BPDUs por cada VLAN** y, cuando ocurre una **falla importante en un enlace trunk**, deben **calcular múltiples operaciones STP** para converger la red.

**MST** ofrece un **enfoque combinado** al **mapear una o varias VLANs** a un **único árbol STP**, denominado **instancia MST (MSTI)**.

La **Figura 4-3** muestra cómo **los tres switches mantienen tres topologías STP** para **4 VLANs**. Si se agregaran **10 VLANs más** a este entorno, los switches **mantendrían tres topologías STP**, ya que las VLANs se **alinean con una de las tres MSTIs existentes**. **VLANs 1 y 2** se correlacionan con una **MSTI**, **VLAN 3** con una **segunda MSTI** y **VLAN 4** con una **tercera MSTI**.

![[20260102075025.png]]

Un **conjunto de switches MST** con la **misma configuración de alto nivel** se conoce como una **región MST**. **MST** incorpora mecanismos que hacen que una **región MST aparezca como un único switch virtual** ante switches externos, como parte de un **mecanismo de compatibilidad**.

La **Figura 4-4** demuestra el concepto más claramente, mostrando la **topología STP real** junto a la **topología percibida** por los dispositivos externos a la región MST. Las **operaciones STP normales** calcularían que **SW5** bloquee el puerto hacia **SW3**, usando las operaciones explicadas en el **Capítulo 2, “Spanning Tree Protocol”**. Sin embargo, se debe tener especial cuidado con la forma en que **SW3** bloquea el puerto hacia **SW5**. Normalmente, **SW3** marcaría ese puerto como **RP**, ya que ve la topología desde una **colección mayor**, bloqueando ese puerto en lugar de bloquear el puerto entre **SW2 y SW3**. Además, **SW7** está bloqueando el puerto hacia la **región MST**. **SW7 y SW5** están a **dos saltos físicos** del **root bridge**, pero **SW5** forma parte del **switch virtual de la región MST** y parece estar a **un solo salto** desde la perspectiva de **SW7**. Por eso **SW7** coloca su puerto en **estado de bloqueo**.

![[20260102075130.png]]

**Instancias MST (MSTIs)**

MST utiliza una **instancia STP especial** llamada **árbol de expansión interno (IST)**, que **siempre es la primera instancia**, **instancia 0**. El **IST** se ejecuta en **todas las interfaces de los switches** dentro de la **región MST**, independientemente de las VLANs asociadas a los puertos. La información adicional sobre **otras MSTIs** se **incluye (anida)** dentro de la **BPDU del IST** que se transmite a lo largo de la región MST. Esto permite que **MST anuncie solo un conjunto de BPDUs**, minimizando el **tráfico STP**, independientemente del número de instancias, mientras proporciona la información necesaria para **calcular STP para las demás MSTIs**.

**NOTA**  
El número de **instancias MST** varía según la plataforma y debería tener **al menos 16 instancias**. El **IST** es siempre la **instancia 0**, por lo que las **instancias 1 a 15** pueden dar soporte a otras VLANs. No existe un nombre especial para las instancias **1 a 15**; simplemente se conocen como **MSTIs**.

**Configuración de MST**

MST se configura siguiendo el siguiente proceso:

**Paso 1.**  
Definir **MST** como el protocolo de spanning tree con el comando **`spanning-tree mode mst`**.

**Paso 2.**  
(Opcional) Definir la **prioridad de la instancia MST**, utilizando uno de los dos métodos siguientes:

- **`spanning-tree mst instance-number priority priority`**  
    La prioridad es un valor entre **0 y 61 440**, en incrementos de **4096**.
    
- **`spanning-tree mst instance-number root (primary | secondary) [diameter diameter]`**  
    La palabra clave **primary** establece la prioridad en **24 576**, y **secondary** la establece en **28 672**.
    

**Paso 3.**  
Asociar **VLANs a una instancia MST**. De forma predeterminada, **todas las VLANs están asociadas a la instancia MST 0**. Se debe ingresar al **submodo de configuración MST** con el comando **`spanning-tree mst configuration`**. Las VLANs se asignan a una instancia MST diferente con el comando **`instance instance-number vlan vlan-id`**.

**Paso 4.**  
Especificar el **número de revisión MST**. El número de revisión MST debe **coincidir en todos los switches** de la misma región MST. El número de revisión se configura con el comando **`revision version`** dentro del submodo MST.

**Paso 5.**  
(Opcional) Definir el **nombre de la región MST**. Las regiones MST se reconocen por switches que comparten un nombre común. De forma predeterminada, el nombre de la región es una **cadena vacía**. El nombre de la región se configura con el comando **`name mst-region-name`**.

El **Ejemplo 4-1** demuestra la configuración de MST en **SW1**. La **instancia MST 2** contiene la **VLAN 99**, la **instancia MST 1** contiene las **VLANs 10 y 20**, y la **instancia MST 0** contiene todas las demás VLANs.

**Ejemplo 4-1: Configuración de MST en SW1**

```plaintext
SW1(config)# spanning-tree mode mst
SW1(config)# spanning-tree mst 0 root primary
SW1(config)# spanning-tree mst 1 root primary
SW1(config)# spanning-tree mst 2 root primary
SW1(config)# spanning-tree mst configuration
SW1(config-mst)# name ENTERPRISE_CORE
SW1(config-mst)# revision 2
SW1(config-mst)# instance 1 vlan 10,20
SW1(config-mst)# instance 2 vlan 99
```

El comando **`show spanning-tree mst configuration`** proporciona una verificación rápida de la configuración MST en un switch. El **Ejemplo 4-2** muestra la salida. Obsérvese que la **instancia MST 0** contiene todas las VLANs excepto las **VLANs 10, 20 y 99**, independientemente de si esas VLANs están configuradas en el switch. La **instancia MST 1** contiene las **VLANs 10 y 20**, y la **instancia MST 2** contiene únicamente la **VLAN 99**.

**Ejemplo 4-2: Verificando la configuración de MST**

```plaintext
SW2# show spanning-tree mst configuration
Name        [ENTERPRISE_CORE]
Revision    2    Instances configured 3

Instance  Vlans mapped
--------  --------------------------------
0         1-9,11-19,21-98,100-4094
1         10,20
2         99
```

**Verificación de MST**

La información relevante de spanning tree puede obtenerse con el comando **`show spanning-tree`**. Sin embargo, los números de VLAN no se muestran; en su lugar, se muestra la instancia MST. Además, el valor de prioridad para un switch es la **prioridad de la instancia MST más la prioridad del switch**. El **Ejemplo 4-3** muestra la salida de este comando.

**Ejemplo 4-3: Revisión breve del estado de MST**

```plaintext
SW1# show spanning-tree
! Output omitted for brevity
! Spanning Tree information for Instance 0 (All VLANs but 10,20, and 99)

MST0
Spanning tree enabled protocol mstp

Root ID    Priority 24576
           Address  0062.ec9d.c500
           This bridge is the root
           Hello Time 2 sec  Max Age 20 sec  Forward Delay 15 sec

Bridge ID  Priority 24576 (priority 24576 sys-id-ext 0)
           Address  0062.ec9d.c500
           Hello Time 2 sec  Max Age 20 sec  Forward Delay 15 sec

Interface       Role Sts Cost   Prio.Nbr Type
-----------     ---- --- -----  -------- ----
Gi1/0/2         Desg FWD 20000  128.2    P2p
Gi1/0/3         Desg FWD 20000  128.3    P2p

! Spanning Tree information for Instance 1 (VLANs 10 and 20)

MST1
Spanning tree enabled protocol mstp

Root ID    Priority 24577
           Address  0062.ec9d.c500
           This bridge is the root
           Hello Time 2 sec  Max Age 20 sec  Forward Delay 15 sec
Bridge ID Priority  24577 (priority 24576 sys-id-ext 1) 
          Address   0062.ec9d.c500 
           Hello Time 2 sec  Max Age 20 sec  Forward Delay 15 sec
Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- ------------------------------- 
Gi1/0/2             Desg FWD 20000     128.2    P2p 
Gi1/0/3             Desg FWD 20000     128.3    P2p 

! Spanning Tree information for Instance 2 (VLAN 99) 

MST2
Spanning tree enabled protocol mstp

Root ID    Priority 24578
           Address  0062.ec9d.c500
           This bridge is the root
           Hello Time 2 sec  Max Age 20 sec  Forward Delay 15 sec

Bridge ID  Priority 24578 (priority 24576 sys-id-ext 2)
           Address  0062.ec9d.c500
           Hello Time 2 sec  Max Age 20 sec  Forward Delay 15 sec

Interface       Role Sts Cost   Prio.Nbr Type
-----------     ---- --- -----  -------- ----
Gi1/0/2         Desg FWD 20000  128.2    P2p
Gi1/0/3         Desg FWD 20000  128.3    P2p
```

Una vista consolidada de la tabla de topología MST se muestra con el comando `show spanning-tree mst [instance-number]`. El parámetro opcional `instance-number` puede incluirse para limitar la salida a una instancia específica. El comando se muestra en el Ejemplo 4-4. Observe que las VLAN se muestran junto a la instancia MST, lo que simplifica la resolución de problemas.

**Ejemplo 4-4:** Vista granular de la topología MST
```
SW1# show spanning-tree mst
! Salida omitida por brevedad

##### MST0   VLAN asignadas: 1-9,11-19,21-98,100-4094
Puente      dirección 0062.ec9d.c500   prioridad 0   (24576 sysid 0)
Raíz        este switch para el CIST
Operacional hello 2, forward delay 15, max age 20, txholdcount 6
Configurado hello 2, forward delay 15, max age 20, max hops 20

Interfaz    Rol  Est  Costo   Prio.Nbr  Tipo
----------- ---- ---- ------- --------- ----
Gi1/0/2     Desg FWD 20000    128.2     P2p
Gi1/0/3     Desg FWD 20000    128.3     P2p

##### MST1   VLAN asignadas: 10,20
Puente      dirección 0062.ec9d.c500   prioridad 24577 (24576 sysid 1)
Raíz        este switch para MST1

Interfaz    Rol  Est  Costo   Prio.Nbr  Tipo
----------- ---- ---- ------- --------- ----
Gi1/0/2     Desg FWD 20000    128.2     P2p
Gi1/0/3     Desg FWD 20000    128.3     P2p

##### MST2   VLAN asignadas: 99
Puente      dirección 0062.ec9d.c500   prioridad 24578 (24576 sysid 2)
Raíz        este switch para MST2

Interfaz    Rol  Est  Costo   Prio.Nbr  Tipo
----------- ---- ---- ------- --------- ----
Gi1/0/2     Desg FWD 20000    128.2     P2p
Gi1/0/3     Desg FWD 20000    128.3     P2p
```

La configuración específica de MST se puede ver para una interfaz concreta con el comando **show spanning-tree mst interface interface-id**, como se muestra en el Ejemplo 4-5. Observa que la salida de este ejemplo incluye información adicional sobre funciones opcionales de STP como **BPDU filter** y **BPDU guard**.

**Ejemplo 4-5:** Visualización de la configuración MST específica de una interfaz
```
SW2# show spanning-tree mst interface gigabitEthernet 1/0/1

GigabitEthernet1/0/1 del MST0 está en root forwarding

Puerto edge: no              (por defecto)     port guard: none      (por defecto)
Tipo de enlace: punto a punto (auto)            bpdu filter: disable  (por defecto)
Boundary: interno                                 bpdu guard: disable   (por defecto)
BPDUs enviadas 17, recibidas 217

Instancia  Rol   Est  Costo   Prio.Nbr  VLANs asociadas
---------  ----  ---  ------  --------  ------------------------------
0          Root  FWD  20000   128.1     1-9,11-19,21-98,100-4094
1          Root  FWD  20000   128.1     10,20
2          Root  FWD  20000   128.1     99
```

**Ajuste de MST**

MST admite el ajuste del costo de puerto y de la prioridad de puerto. El comando de configuración de interfaz **spanning-tree mst instance-number cost cost** establece el costo de la interfaz. El Ejemplo 4-6 demuestra cómo se modifica el costo a 1 en la interfaz Gi1/0/1 de SW3 y la verificación del costo de la interfaz antes y después del cambio.

**Ejemplo 4-6:** Cambio del costo de la interfaz MST
```
SW3# show spanning-tree mst 0
! Salida omitida por brevedad
Interface     Role  Sts  Cost   Prio.Nbr  Type
-----------   ----  ---  -----  --------  ----
Gi1/0/1       Root  FWD  20000  128.1     P2p
Gi1/0/2       Altn  BLK  20000  128.2     P2p
Gi1/0/5       Desg  FWD  20000  128.5     P2p

SW3# configure terminal
Enter configuration commands, one per line. End with CNTL/Z.
SW3(config)# interface gi1/0/1
SW3(config-if)# spanning-tree mst 0 cost 1

SW3# show spanning-tree mst 0
! Salida omitida por brevedad
Interface     Role  Sts  Cost  Prio.Nbr  Type
-----------   ----  ---  ----  --------  ----
Gi1/0/1       Root  FWD  1     128.1     P2p
Gi1/0/2       Desg  FWD  20000 128.2     P2p
Gi1/0/5       Desg  FWD  20000 128.5     P2p
```

El comando de configuración de interfaz **spanning-tree mst instance-number port-priority priority** establece la prioridad de la interfaz. El Ejemplo 4-7 demuestra la configuración del puerto Gi1/0/5 de SW4 con una prioridad de 64 y la verificación de la prioridad de la interfaz antes y después del cambio.

**Ejemplo 4-7:** Cambio de la prioridad de la interfaz MST
```
SW4# show spanning-tree mst 0
! Salida omitida por brevedad
#### MST0  vlans mapped: 1-9,11-19,21-98,100-4094
Interface     Role  Sts  Cost   Prio.Nbr  Type
-----------   ----  ---  -----  --------  ----
Gi1/0/2       Root  FWD  20000  128.2     P2p
Gi1/0/5       Desg  FWD  20000  128.5     P2p
Gi1/0/6       Desg  FWD  20000  128.6     P2p

SW4# configure terminal
Enter configuration commands, one per line. End with CNTL/Z.
SW4(config)# interface gi1/0/5
SW4(config-if)# spanning-tree mst 0 port-priority 64

SW4# show spanning-tree mst 0
! Salida omitida por brevedad
#### MST0  vlans mapped: 1-9,11-19,21-98,100-4094
Interfaz        Rol   Est  Costo  Prio.Nbr  Tipo
-------------  ----  ---  -----  --------  ----
Gi1/0/2        Root  FWD  20000  128.2     P2p
Gi1/0/5        Desg  FWD  20000  64.5      P2p
Gi1/0/6        Desg  FWD  20000  128.6     P2p
```

Las **configuraciones incorrectas comunes de MST**  
Los ingenieros de red deben ser conscientes de dos configuraciones incorrectas comunes dentro de una región MST:

- Asignación de VLAN al IST
    
- Poda de enlaces troncales (trunk link pruning)
    

Estos escenarios se explican en las siguientes secciones.

**Asignación de VLAN al IST**  
Recuerda que el **IST** opera a través de todos los enlaces en la región MST, independientemente de la VLAN asignada al puerto real. La topología del IST puede no correlacionarse con la capa de acceso y podría introducir un puerto en estado de bloqueo que no era intencional.

La Figura 4-5 presenta una topología de ejemplo en la que la VLAN 10 está asignada al IST y la VLAN 20 está asignada a la instancia MSTI 1. SW1 y SW2 contienen dos enlaces de red entre ellos, con las VLAN 10 y VLAN 20. El tráfico entre PC-A y PC-B fluiría a través de la interfaz Gi1/0/2, ya que es un puerto de acceso asignado a la VLAN 10; sin embargo, todas las interfaces pertenecientes a la instancia IST. SW1 es el puente raíz, y todos sus puertos son puertos designados (DP). Por lo tanto, SW2 debe bloquear Gi1/0/1 o Gi1/0/2. SW2 bloquea Gi1/0/2 basándose en el identificador de puerto de SW1, que es Gi1/0/2. Así, SW2 bloquea Gi1/0/2 para la instancia IST, que es la instancia a la que está mapeada la VLAN 10.

![[20260102081021.png]]

Existen dos soluciones para este escenario:

- Mover la VLAN 10 a una instancia MSTI distinta del IST. Si se hace esto, los switches construirán una topología basada en los enlaces utilizados por esa MSTI.
    
- Permitir todas las VLAN asociadas con el IST en todos los enlaces entre switches (troncales).
    

**Poda de enlaces troncales (Trunk Link Pruning)**  
La poda de VLAN en un enlace troncal es una práctica común para el balanceo de carga. Sin embargo, es importante entender que la poda de VLAN no ocurre para VLAN que pertenecen a la misma instancia MST en enlaces de red diferentes.

La Figura 4-6 presenta una topología de ejemplo en la que las VLAN 10 y VLAN 20 se transportan a lo largo de toda la topología. Un ingeniero de red junior ha podado VLAN en los enlaces troncales entre SW1 y SW2, y entre SW1 y SW3, para ayudar a balancear el tráfico. Poco después de implementar el cambio, los usuarios conectados a SW1 y SW3 no pueden comunicarse con los servidores en SW2. La razón es que, aunque las VLAN en los enlaces troncales han cambiado, la topología de la MSTI no lo ha hecho.

![[20260102081241.png]]

**Límite de región MST (MST Region Boundary)**  
La topología de todas las instancias MST está contenida dentro del IST, que opera internamente a la región MST. Un límite de región MST es cualquier puerto que se conecta a un switch que está en una región MST diferente o que transporta BPDUs 802.1D o 802.1W.

Las MSTI nunca interactúan fuera de la región. Los switches MST pueden detectar vecinos PVST+ como límites de región MST. La propagación del CST (derivado del IST) en el límite de región MST utiliza una característica llamada **mecanismo de simulación PVST**.

El mecanismo de simulación PVST envía BPDUs PVST+ (y también BPDUs RPVST, una por cada VLAN), utilizando la información del IST. Para ser explícitos, esto requiere un mapeo de una topología (IST) a múltiples VLAN (VLANs sin PVST). El mecanismo de simulación PVST es necesario porque las topologías PVST+/RPVST no entienden la estructura de BPDUs del IST.

Cuando el límite MST recibe BPDUs PVST+, no mapea las VLAN a las MSTI correspondientes. En su lugar, el límite MST mapea únicamente la BPDU PVST+ de la VLAN 1 a la instancia IST. El límite MST activa el mecanismo de simulación PVST solo cuando recibe una BPDU PVST en un puerto.

Existen dos consideraciones de diseño al integrar una región MST con un entorno PVST+/RPVST. La región MST es el puente raíz, o la región MST no es el puente raíz para ninguna VLAN. Estos escenarios se explican en las siguientes secciones.

**La región MST como puente raíz**  
Hacer que la región MST sea el puente raíz garantiza que todos los puertos de límite de la región inunden la misma BPDU de la instancia IST a todas las VLAN en la topología PVST. Hacer que la instancia IST sea más preferida que cualquier otro switch en la topología PVST+ habilita este diseño. La región MST aparece como una sola entidad, y los switches PVST+ detectan el enlace alternativo y lo colocan en estado de bloqueo.

La Figura 4-7 muestra a la instancia IST como el puente raíz para todas las VLAN. SW1 y SW2 anuncian múltiples BPDUs superiores para cada VLAN hacia SW3, que opera como un switch PVST+. SW3 es responsable de los puertos bloqueados.

![[20260102081509.png]]

> **NOTA**  SW3 podría balancear la carga de tráfico entre las VLAN configurando el costo STP de forma independiente por VLAN en cada enlace.

**Región MST no como puente raíz para ninguna VLAN**  
En este escenario, los puertos de límite de la región MST solo pueden bloquear o reenviar para todas las VLAN. Recuerde que solo la BPDU STP de la VLAN 1 se utiliza para el IST y que la BPDU del IST es una traducción uno-a-muchos de BPDUs IST a todas las BPDUs PVST. No existe una opción para balancear la carga de tráfico porque la instancia IST debe permanecer consistente.

Si un switch MST detecta una BPDU superior para una VLAN específica en un puerto de límite, el switch quedará bloqueado por BPDU guard. El puerto será colocado en un estado inconsistente de raíz. Aunque esto podría aislar switches aguas abajo, se hace para garantizar una topología libre de bucles; a esto se le llama **verificación de simulación PVST (PVST simulation check)**.
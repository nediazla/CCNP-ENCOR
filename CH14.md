# **Capítulo 14 – Quality of Service (QoS)**

## **1. Introducción**

**Quality of Service (QoS)** es el conjunto de técnicas que permiten **gestionar el tráfico de red** para garantizar rendimiento, prioridad y disponibilidad ante congestión.  
Su objetivo es **controlar la latencia, el jitter y la pérdida de paquetes**, asegurando una experiencia consistente para aplicaciones críticas como:

- Voz sobre IP (VoIP)
    
- Video conferencias
    
- Aplicaciones de tiempo real (telemetría, SCADA)
    
- Tráfico empresarial sensible (ERP, servicios en la nube)
    

**Concepto clave:**  
Cuando los recursos de red (ancho de banda, colas, buffers) son limitados, QoS **decide quién obtiene prioridad y quién debe esperar.**

---

## **2. Los tres problemas principales de tráfico**

1. **Delay (Retardo):** tiempo que tarda un paquete en llegar a destino.
    
2. **Jitter (Variación del retardo):** inconsistencia entre los tiempos de entrega.
    
3. **Packet Loss (Pérdida):** paquetes descartados por congestión o buffers llenos.
    

**Valores recomendados para voz:**

- Delay: <150 ms
    
- Jitter: <30 ms
    
- Packet Loss: <1%
    

---

## **3. Mecanismos de QoS**

QoS agrupa múltiples herramientas, que se dividen en tres fases:

|Fase|Función|Ejemplo|
|---|---|---|
|**Classification & Marking**|Identificar y etiquetar tráfico.|ACL, NBAR, DSCP|
|**Queuing & Scheduling**|Asignar prioridad o colas de espera.|LLQ, CBWFQ|
|**Congestion & Policing/Shaping**|Controlar y limitar velocidad.|Policing, Shaping|

---

## **4. Clasificación y Marcado**

### **Clasificación**

Proceso de identificar el tipo de tráfico (por protocolo, puerto, dirección o aplicación).

- **Herramientas:**
    
    - ACLs (Access Control Lists)
        
    - NBAR (Network-Based Application Recognition)
        
    - Class Maps
        

### **Marcado (Marking)**

Una vez identificado el tráfico, se etiqueta para priorizarlo a lo largo de la red.

|Capa|Campo|Bits|Protocolo|
|---|---|---|---|
|2|CoS (Class of Service)|3 bits|802.1Q VLAN Tag|
|3|DSCP (Differentiated Services Code Point)|6 bits|IP Header|
|3|IP Precedence|3 bits|Obsoleto|
|MPLS|EXP bits|3 bits|QoS en core MPLS|

**Ejemplo:**

```
class-map match-any VOICE
 match ip dscp ef
policy-map QOS_POLICY
 class VOICE
  priority 200
```

---

## **5. DSCP y DiffServ**

**Differentiated Services (DiffServ)** reemplaza al antiguo modelo IntServ y define el marcado DSCP en 6 bits dentro del encabezado IP.

### **Clases DSCP comunes**

|DSCP|Valor decimal|Tipo de servicio|
|---|---|---|
|EF|46|Expedited Forwarding (voz)|
|AF11 / AF12 / AF13|10 / 12 / 14|Background / datos bajos|
|AF21 / AF22 / AF23|18 / 20 / 22|Transaccional|
|AF31 / AF32 / AF33|26 / 28 / 30|Video|
|CS0–CS7|0–56|Clases de servicio estándar|

---

## **6. Clasificación por capa 2 (CoS)**

En redes Ethernet con VLAN tagging (IEEE 802.1Q), los tres bits **CoS (Class of Service)** dentro del tag VLAN indican prioridad (0–7).

|Valor|Prioridad|Tipo|
|---|---|---|
|0|Best Effort|Tráfico normal|
|5|Voice|Alta prioridad|
|6–7|Network Control|Protocolos internos (routing, STP)|

---

## **7. Modelos de QoS**

|Modelo|Descripción|Escalabilidad|
|---|---|---|
|**Best Effort**|Sin QoS; todos los paquetes iguales.|Alta|
|**Integrated Services (IntServ)**|Reserva explícita de recursos usando RSVP.|Baja|
|**Differentiated Services (DiffServ)**|Basado en clases; usa DSCP y políticas.|Alta (más común)|

**El modelo DiffServ es el usado en redes empresariales y en el examen ENCOR.**

---

## **8. Mecanismos de Control de Congestión**

### **Tail Drop**

Descarta paquetes cuando el buffer se llena → provoca sincronización global TCP.

### **WRED (Weighted Random Early Detection)**

Descarta aleatoriamente paquetes antes de que el buffer se llene, basándose en su **DSCP** o prioridad.  
Evita congestión prematura y mejora el rendimiento TCP.

```
random-detect dscp-based
```

---

## **9. Queuing y Scheduling (Colas y planificación)**

Cuando los paquetes llegan más rápido de lo que pueden transmitirse, se almacenan en colas.

### **Tipos principales de colas**

|Mecanismo|Descripción|Uso típico|
|---|---|---|
|**FIFO**|Cola única, sin prioridad.|Best effort|
|**PQ (Priority Queuing)**|Cola estricta de prioridad (voz, video).|Tráfico crítico|
|**CBWFQ (Class-Based Weighted Fair Queuing)**|Divide tráfico por clases.|Control granular|
|**LLQ (Low-Latency Queuing)**|CBWFQ + cola prioritaria.|Voz / tiempo real|

**Ejemplo:**

```
policy-map VOICE-VIDEO
 class VOICE
  priority percent 30
 class VIDEO
  bandwidth percent 40
```

---

## **10. Policing y Shaping**

Ambos limitan la tasa de transmisión, pero de forma distinta.

|Mecanismo|Descripción|Efecto|
|---|---|---|
|**Policing**|Descarte inmediato de paquetes que exceden el límite.|Duro, reduce tráfico.|
|**Shaping**|Retrasa el exceso de tráfico almacenándolo temporalmente.|Suaviza flujo.|

**Ejemplo:**

```
policy-map POLICE_10M
 class class-default
  police 10000000 8000 8000 conform-action transmit exceed-action drop
```
---

## **11. Link Fragmentation and Interleaving (LFI)**

Reduce el retardo en enlaces WAN de baja velocidad fragmentando grandes tramas y enviando paquetes de voz intercalados.

**Ejemplo de uso:**  
Enlaces seriales o Frame Relay (antiguamente).

---

## **12. QoS Trust Boundaries**

Define en qué punto de la red **se confía en las marcas QoS**.

- **Acceso:** generalmente los switches reetiquetan el tráfico.
    
- **Distribución/Core:** se confía en los valores marcados (trust boundary).
    

**Comando:**

```
mls qos trust dscp
```

---

## **13. Network-Based Application Recognition (NBAR)**

Permite identificar aplicaciones más allá de puerto o IP, usando inspección de capa 7.

**Ejemplo:**

```
class-map match-any VIDEO
 match protocol rtsp
 match protocol rtp
```
NBAR se usa junto con **CBWFQ** o **policies de shaping**.

---

## **14. Modular QoS CLI (MQC)**

Cisco estandarizó la configuración de QoS en tres bloques:

1. **Class-map:** define cómo identificar tráfico.
    
2. **Policy-map:** define la acción (priorizar, limitar, etc.).
    
3. **Service-policy:** aplica la política a la interfaz.
    

**Ejemplo completo:**

```
class-map match-any VOICE
 match ip dscp ef

policy-map WAN_QOS
 class VOICE
  priority 128
 class class-default
  fair-queue

interface Serial0/0
 service-policy output WAN_QOS
```

---

## **15. Verificación y Diagnóstico**

|Comando|Descripción|
|---|---|
|`show policy-map interface`|Muestra estadísticas de QoS aplicadas.|
|`show class-map`|Revisa las clases configuradas.|
|`show policy-map`|Verifica políticas y colas.|
|`show mls qos interface`|QoS en switches Catalyst.|
|`debug policy-map`|Diagnóstico en tiempo real.|
